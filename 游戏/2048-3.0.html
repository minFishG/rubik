<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2048-3.0</title>
    <style>
        #box{
            background-color: #bbada0;position: relative;
            margin: 30px auto;width: 460px;height: 460px;
        }
        #bo1>div,#bo2>div{
            background-color:rgb(204, 192, 179);text-align: center;position: absolute;
            line-height: 100px;font-size: 25px;height: 100px;width: 100px;
        }
        #bo2>div{
            z-index: 100;
        }
    </style>
    <script>
        function getstyle(obj,attr) {
            if(obj.currentStyle){
                return obj.currentStyle[attr];
            }else{
                return window.getComputedStyle(obj,null)[attr];
            }
        }
        function startmove(obj,json,fn) {
            clearInterval(obj.timer);
            obj.timer = setInterval(function () {
                var bstop=true;
                for(var attr in json){
                    var icur =0;
                    if(attr=="opacity"){
                        icur=parseInt(parseFloat(getstyle(obj,attr))*100);
                    }else{
                        icur=parseInt(getstyle(obj,attr));
                    }
                    var iSpeed = (json[attr] - icur) / 3;
                    iSpeed = iSpeed > 0 ? Math.ceil(iSpeed) : Math.floor(iSpeed);
                    if (icur != json[attr]) {
                        bstop=false;
                    }
                    if(attr=="opacity"){
                        obj.style.filter='alpha(opacity:'+(icur+iSpeed)+')';
                        obj.style.opacity=(icur+iSpeed)/100;
                    }else{
                        obj.style[attr]= icur + iSpeed+"px";
                    }
                }
                if(bstop){clearInterval(obj.timer);if(fn){fn();}}}, 30)
        }
        function buildgame() {
            var bo1=document.getElementById("bo1");
            var bo2=document.getElementById("bo2");bo2.a=0;bo2.b=1;
            var po=document.getElementById("poi");po.a=0;
            var a=0,b=12;
            for(var i=0;i<16;i++){
                var bl1=document.createElement("div");
                var bl2=document.createElement("div");
                if(i>3&&i<8){
                    a=4;b=124;
                }else if(i>7&&i<12){
                    a=8;b=236;
                }else if(i>11){
                    a=12;b=348;
                }
                bl1.style.left=112*(i-a)+12+"px";bl1.style.top=b+"px";
                bl2.po=0;
                bl2.le=112*(i-a)+12;bl2.to=b;
                bl2.style.left=bl2.le+"px";bl2.style.top=b+"px";
                bo1.appendChild(bl1);bo2.appendChild(bl2);
            }
            document.onkeydown=function (e) {
                var ev=e.keyCode||event.keyCode;
                  if(ev==37){
                      takepoints(1);
                  }else if(ev==38){
                      takepoints(2);
                  }else if(ev==39){
                      takepoints(3);
                  }else if(ev==40){
                      takepoints(4);
                  }
            };
            newdiv(2);
        }
        function addpoi() {
            var po=document.getElementById("poi");
            po.a+=1;
            po.innerHTML="分数："+po.a;
        }
        function newdiv(n){
            var bo2=document.getElementById("bo2");
            var bl2=bo2.getElementsByTagName("div");
            var ys={2: "rgb(238, 228, 218)",4:"rgb(237, 224, 200)"};
            for(var m=0;m<n;m++){
                var ano=[];
                for(var i=0;i<bl2.length;i++){
                    if(bl2[i].po==0){ano.push(bl2[i]);}
                }
                var r1=Math.floor(Math.random()*ano.length);
                ano[r1].innerHTML=ano[r1].po=(Math.random()>0.5?2:4);
                ano[r1].style.backgroundColor=ys[ano[r1].po];
            }
        }
        function takepoints(k) {
            var bo2=document.getElementById("bo2");
            var bl2=bo2.getElementsByTagName("div");
            var a=0,i=0,s1=0,s2=0,s3=0,s4=1,s5=0,t1=0,t2=0,t3=0,t4=0;
            if(k==1){//左
                s1=4;s2=4;t2=4;t3=1;
            }else if(k==2){//上
                s1=1;t2=16;t3=4;
            }else if(k==3){//右
                s4=0;s1=-4;t1=15;s5=-4;t4=11;s3=1;t3=-1;
            }else if(k==4){//下
                s4=0;s1=-1;t1=15;t4=-1;s3=1;t3=-4;
            }
            var arr=[[],[],[],[]],arr1=[[],[],[],[]];
            for(i;i<4;i++){
                for(a=i*s1+t1;a*s4+i*s5+t4<i*s2+t2+a*s3;a+=t3){
                   if(bl2[a].po>0){
                       arr[i].push(bl2[a]);
                       arr1[i].push(bl2[a].po);
                   }
                }
                if(arr[i].length==1){
                    movediv(arr,i,i*s1+t1,0,arr1,2);
                }else if(arr[i].length==2){
                    if(arr1[i][0]==arr1[i][1]){
                        movediv(arr,i,i*s1+t1,0);addpoi();
                        movediv(arr,i,i*s1+t1,1,arr1,1);
                    }else{
                        movediv(arr,i,i*s1+t1,0,arr1,2);
                        movediv(arr,i,i*s1+t1+t3,1,arr1,2);
                    }
                }else if(arr[i].length==3){
                    if(arr1[i][0]==arr1[i][1]){
                        movediv(arr,i,i*s1+t1,0);addpoi();
                        movediv(arr,i,i*s1+t1,1,arr1,1);
                        movediv(arr,i,i*s1+t1+t3,2,arr1,2);
                    }else{
                        movediv(arr,i,i*s1+t1,0,arr1,2);
                        if(arr1[i][2]==arr1[i][1]){
                            movediv(arr,i,i*s1+t1+t3,1);addpoi();
                            movediv(arr,i,i*s1+t1+t3,2,arr1,1);
                        }else{
                            movediv(arr,i,i*s1+t1+t3,1,arr1,2);
                            movediv(arr,i,i*s1+t1+t3*2,2,arr1,2);
                        }
                    }
                }else if(arr[i].length==4){
                    if(arr1[i][0]==arr1[i][1]){
                        movediv(arr,i,i*s1+t1,0);addpoi();
                        movediv(arr,i,i*s1+t1,1,arr1,1);
                        if(arr1[i][2]==arr1[i][3]){
                            movediv(arr,i,i*s1+t1+t3,2);addpoi();
                            movediv(arr,i,i*s1+t1+t3,3,arr1,1);
                        }else{
                            movediv(arr,i,i*s1+t1+t3,2,arr1,2);
                            movediv(arr,i,i*s1+t1+(t3*2),3,arr1,2);
                        }
                    }else if(arr1[i][2]==arr1[i][1]){
                        movediv(arr,i,i*s1+t1,0,arr1,2);addpoi();
                        movediv(arr,i,i*s1+t1+t3,1);
                        movediv(arr,i,i*s1+t1+t3,2,arr1,1);
                        movediv(arr,i,i*s1+t1+(t3*2),3,arr1,2);

                    }else if(arr1[i][2]==arr1[i][3]){
                        movediv(arr,i,i*s1+t1,0,arr1,2);addpoi();
                        movediv(arr,i,i*s1+t1+t3,1,arr1,2);
                        movediv(arr,i,i*s1+t1+(t3*2),2);
                        movediv(arr,i,i*s1+t1+(t3*2),3,arr1,1);
                    }
                }
            }
            bo2.a=1;
        }
        function movediv(arr,i,a,b,arr1,c) {
            var bo2=document.getElementById("bo2");
            var bl2=bo2.getElementsByTagName("div");
            var ys={0:"rgb(204, 192, 179)",2: "rgb(238, 228, 218)",4:"rgb(237, 224, 200)"
                ,8:"rgb(242, 177, 121)",16:"rgb(245, 149, 99)",32:"rgb(246, 126, 95)"
                ,64:"rgb(246, 94, 59)",128:"rgb(237, 207, 114)",256:"rgb(37,80,208)"};
            if(arr[i][b]!=bl2[a]){
                arr[i][b].style.zIndex="1000";
                startmove(arr[i][b],{left:bl2[a].le,top:bl2[a].to},function () {
                    arr[i][b].po=0;arr[i][b].innerHTML="";
                    arr[i][b].style.left=arr[i][b].le+"px";arr[i][b].style.top=arr[i][b].to+"px";
                    arr[i][b].style.zIndex="100";
                    arr[i][b].style.backgroundColor=ys[0];
                    if(arr1){
                        if(c==1){
                            bl2[a].po=arr1[i][b]*2;
                        }else if(c==2){
                            bl2[a].po=arr1[i][b];
                        }
                        bl2[a].innerHTML=bl2[a].po;
                    }
                    if(bl2[a].po>128){
                        bl2[a].style.backgroundColor=ys[256];
                    }else if(bl2[a].po>0&&bl2[a].po<256){
                        bl2[a].style.backgroundColor=ys[bl2[a].po];
                    }
                    if(bo2.a==0){
                        newdiv(1);bo2.a=2;
                    }else if(bo2.a==1){
                        newdiv(1);bo2.a=2;
                    }
                });
            }
        }
        window.onload=function () {
            buildgame();
        }
    </script>
</head>
<body>
<div id="poi">分数：</div>
<div id="box">
    <div id="bo1"></div>
    <div id="bo2"></div>
    <div id="bono" ></div>
</div>

</body>
</html>