<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2048-2th</title>
    <style>
        #my2048{
            background-color: #bbada0;position: relative;
            margin: 30px auto;width: 460px;height: 460px;
        }
        #my2048 div{
            background-color:rgb(204, 192, 179);text-align: center;position: absolute;
            line-height: 100px;font-size: 25px;height: 100px;width: 100px;
        }
    </style>
    <script>
        function buildGame(){
            var my2048=document.getElementById("my2048");
            var a=0,b=12;
            for(var i=0;i<16;i++){
                var kuai=document.createElement("div");
                if(i>3&&i<8){
                    a=4;b=124;
                }else if(i>7&&i<12){
                    a=8;b=236;
                }else if(i>11){
                    a=12;b=348;
                }
                kuai.now=0;kuai.d=0;
                kuai.style.left=112*(i-a)+12+"px";kuai.style.top=b+"px";
                my2048.appendChild(kuai);
            }
        }
        function newGame(){
            var kuai=document.getElementById("my2048").getElementsByTagName("div");
            var lvs=[];
            for(var i=0;i<kuai.length;i++){
                if(kuai[i].now==0){
                    lvs.push(kuai[i]);
                }
            }
            if(lvs.length>0){
                var a=Math.floor(Math.random()*lvs.length),b=Math.floor(Math.random()*2),c=[2,4];
                var nys=["rgb(238, 228, 218)","rgb(237, 224, 200)"];
                lvs[a].style.backgroundColor=nys[b];
                lvs[a].innerHTML=lvs[a].now=lvs[a].d=c[b];
            }
        }
        function countDiv(a,narr){
            var my2048=document.getElementById("my2048");
            var kuai=my2048.getElementsByTagName("div");
            var arr=[[],[],[],[]];
            var t1=0,t2=0,t3=0,t4=0,d=0,t5=0,t6=0,t7=0,t8=0,t9=0,i=0;
             if(a==1){//________左
                 t1=4;t2=4;t3=4;t4=1;
             }else if(a==2){//________上
                 t1=1;t2=0;t3=16;t4=4;
             }else if(a==3){//________右
                 t5=-1;t6=-4;t7=11;t8=-4;t9=15;
             }else if(a==4){//________下
                 t8=-1;t9=15;t6=0;t7=-1;t5=-4;
             }
             for(var z=0;z<4;z++){
                     for(d=((z*t8)+t9),i=z*t1;i+(z*t6+t7)<d+(t2*z+t3);i+=t4,d+=t5){
                        if(a==3||a==4){
                            var kd=d;
                        }else{
                            var kd=i;
                        }
                         if(arguments.length>1){
                            if(narr[z].length>0){
                                kuai[kd].innerHTML=kuai[kd].now=narr[z][0];
                                narr[z].splice(0,1);
                                setColor(kd);
                                if(kuai[kd].d==kuai[kd].now){
                                    my2048.m=0;
                                }else if(kuai[kd].d!=kuai[kd].now){
                                    my2048.m=1;
                                }
                            }
                         }else{
                            kuai[kd].d=kuai[kd].now;
                             if(kuai[kd].now!=0){
                                 arr[z].push(kuai[kd].now);
                             }
                             kuai[kd].innerHTML="";kuai[kd].now=0;
                             kuai[kd].style.backgroundColor="rgb(204, 192, 179)";
                         }
                     }
                 }
                 if(arguments.length>0){
                     return arr;
                 }
        }
        function setColor(i) {
            var kuai=document.getElementById("my2048").getElementsByTagName("div");
            var ki=kuai[i].innerHTML,s=0;
            var ys=["rgb(204, 192, 179)", "rgb(238, 228, 218)"//2
                ,"rgb(237, 224, 200)"//4
                ,"rgb(242, 177, 121)"//8
                ,"rgb(245, 149, 99)"//16
                ,"rgb(246, 126, 95)","rgb(246, 94, 59)"
            ,"rgb(237, 207, 114)","rgb(37,80,208)"];
            if(ki=="2"){
                s=1;
            }else if(ki=="4"){
                s=2;
            }else if(ki=="8"){
                s=3;
            }else if(ki=="16"){
                s=4;
            }else if(ki=="32"){
                s=5;
            }else if(ki=="64"){
                s=6;
            }else if(ki=="128"){
                s=7;
            }else if(ki>"128"){
                s=8;
            }
            kuai[i].style.backgroundColor=ys[s];
        }
        function movingDiv(narr){
              for(var i=0;i<4;i++) {
                  if (narr[i].length > 1) {
                      if (narr[i][0] == narr[i][1]) {
                          narr[i][0] += narr[i][1];point();
                          narr[i].splice(1, 1);
                          if (narr[i].length == 3&&(narr[i][1] == narr[i][2])) {
                                  narr[i][1] += narr[i][2];point();
                                  narr[i].splice(2, 1);
                          }
                      } else if (narr[i].length > 2&&(narr[i][1] == narr[i][2])) {
                              narr[i][1] += narr[i][2];point();
                              narr[i].splice(2, 1);
                      } else if(narr[i].length == 4&&(narr[i][2] == narr[i][3])){
                              narr[i][2] += narr[i][3];point();
                              narr[i].splice(3, 1);
                      }

                  }
              }
              return narr;
        }
        function point(){
            var pt=document.getElementById("points");
            pt.p+=1;
            pt.innerHTML="分数："+pt.p;
        }
        window.onload=function () {
            buildGame();
            newGame();
            newGame();
            var pt=document.getElementById("points");pt.p=0;
            var my2048=document.getElementById("my2048");my2048.m=0;
            document.onkeydown=function (e) {
                var c=e.keyCode||event.keyCode;
                if(c==37){//________左
                    countDiv(1,movingDiv(countDiv(1)));
                }else if(c==38){//________上
                    countDiv(2,movingDiv(countDiv(2)));
                }else if(c==39){//________右
                    countDiv(3,movingDiv(countDiv(3)));
                }else if(c==40){//________下
                    countDiv(4,movingDiv(countDiv(4)));
                }
                if((c==37||c==38||c==39||c==40)&&(my2048.m==1)){
                    newGame();
                }
            };
        };
    </script>
</head>
<body>
<div id="points">分数：</div>
<div id="my2048"></div>
</body>
</html>